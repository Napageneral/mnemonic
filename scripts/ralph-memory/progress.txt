# Cortex Memory System — Progress Log

## Codebase Patterns

*(Add reusable patterns here as you discover them)*

### Project Structure
- `cmd/cortex/` — CLI entry point
- `internal/db/` — Database layer, schema.sql
- `internal/` — Core packages
- `prompts/graphiti/` — LLM prompts for extraction

### Schema Conventions
- Tables use snake_case
- Primary keys are TEXT (UUIDs)
- Timestamps are INTEGER (Unix epoch) or TEXT (ISO 8601)
- JSON fields end with `_json` suffix
- Foreign keys have ON DELETE CASCADE where appropriate

### Go Conventions
- Packages are lowercase, single word when possible
- Structs match table names in PascalCase
- Use context.Context for cancellation
- Errors are returned, not panicked

### Naming: Segments → Episodes
- **Schema**: `episodes`, `episode_definitions`, `episode_events` tables
- **Go code**: Use `Episode*` types and `episode*` variables
- **SQL queries**: Reference `ee.episode_id` not `se.segment_id`
- **JSON**: Can keep `segment_id` in JSON for backward compatibility with queued jobs
- **CLI output**: Use "episodes" in user-facing messages

---

## Progress Log

*(Append entries below as stories are completed)*

---
## 2026-01-21 - [MS-001] Rename segments to episodes in Go code
- Renamed all Go code references from `segment` to `episode`
- Updated SQL queries in engine.go, nexus_cli.go, aix_facets.go, main.go, aix.go
- Updated struct fields: `SegmentID` → `EpisodeID`, `SegmentsCreated` → `EpisodesCreated`
- Updated function names: `buildSegmentText` → `buildEpisodeText`, `getSegmentPreview` → `getEpisodePreview`
- Schema was already correct (episodes, episode_events, episode_definitions)
- JSON keys kept as `segment_id` in AnalysisJobPayload for backward compatibility with queued jobs

**Files changed:**
- `internal/compute/engine.go` - SQL queries, struct fields, function names
- `internal/compute/nexus_cli.go` - SQL queries, function signatures
- `internal/adapters/aix_facets.go` - SQL queries, struct fields, function names
- `internal/live/aix.go` - Log message output field
- `cmd/cortex/main.go` - CLI result structs, SQL queries, function names
- `AGENTS.md` - Schema quick reference
- `scripts/ralph-memory/progress.txt` - This entry

**Learnings:**
- The schema.sql was already migrated to use `episodes` terminology
- Go code had many lingering references to `segment_events` table and `segment_id` columns
- SQL column names must match schema exactly - was getting silent failures before
- Keep JSON keys stable for backward compatibility with queued jobs
- search/types.go already had backward compatibility aliases (SegmentSearchRequest = EpisodeSearchRequest)

---
## 2026-01-21 - [MS-002] Add entities table to schema
- Added `entities` table to schema.sql following spec §3.4
- Columns: id, canonical_name, entity_type_id, summary, summary_updated_at, origin, confidence, merged_into, created_at, updated_at
- Added indexes: idx_entities_type (entity_type_id), idx_entities_name (canonical_name)
- Schema version incremented from 13 to 14
- Uses TEXT for timestamps (ISO 8601 format) per spec convention
- entity_type_id maps to code-defined types (0=Entity, 1=Person, 2=Company, 3=Project, 4=Location, 5=Event, 6=Document, 7=Pet)

**Files changed:**
- `internal/db/schema.sql` - Added entities table and indexes

**Learnings:**
- Schema uses TEXT for timestamp columns with ISO 8601 format (not INTEGER Unix epoch like some older tables)
- merged_into uses self-referential FK for tracking entity merges
- Table has IF NOT EXISTS clause for safe re-application
- Indexes also use IF NOT EXISTS for idempotent schema application

---
## 2026-01-21 - [MS-003] Add entity_aliases table to schema
- Added `entity_aliases` table to schema.sql following spec §3.4
- Columns: id, entity_id (FK to entities), alias, alias_type, normalized, is_shared, created_at
- NO UNIQUE constraint on alias - same alias can map to multiple entities (family phone, team email)
- Added indexes: idx_entity_aliases_lookup (alias, alias_type), idx_entity_aliases_normalized (normalized, alias_type), idx_entity_aliases_entity (entity_id)
- Schema version incremented from 14 to 15
- alias_type values: 'name', 'email', 'phone', 'handle', 'username', 'nickname'

**Files changed:**
- `internal/db/schema.sql` - Added entity_aliases table and indexes

**Learnings:**
- Entity aliases are intentionally NOT unique to support shared identifiers (family phone, team email)
- is_shared BOOLEAN field tracks when multiple entities share an alias for disambiguation during resolution
- Identity relationships (HAS_EMAIL, HAS_PHONE, HAS_HANDLE) get promoted to aliases table, not stored in relationships table
- normalized column enables case-insensitive matching without runtime LOWER() calls

