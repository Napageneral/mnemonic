# Ralph Progress Log — Identity Resolution
Started: (pending Eve migration completion)

## Codebase Patterns
- Use raw SQL, not ORM (user rule)
- No __init__.py files needed
- modernc.org/sqlite for pure-Go SQLite
- JSON output support via --json flag on all commands
- XDG-compliant paths for config/data
- UUID generation with github.com/google/uuid
- Time as Unix timestamps (INTEGER)
- Existing packages to reference:
  - internal/identify/ - existing identity resolution code
  - internal/db/db.go - database connection patterns
  - internal/query/ - query building patterns
  - internal/adapters/ - data sync patterns

## Key Files
- docs/IDENTITY_RESOLUTION_PLAN.md - the spec
- prompts/pii-extraction-v1.prompt.md - extraction prompt
- internal/db/schema.sql - current schema
- internal/identify/suggestions.go - existing merge suggestions (to extend)

## Design Decisions
1. Identifier-centric resolution: O(F) not O(P²)
   - GROUP BY fact_value, find collisions
   - Don't compare all person pairs

2. Hard vs soft identifiers:
   - Hard: 1 match = merge candidate (email, phone, full_name)
   - Compound: all parts match = merge (name+birthdate, name+employer+city)
   - Soft: accumulate weighted scores (employer 0.20, location 0.15, etc.)
   
3. Professional distinction:
   - employer_current = work FOR someone
   - business_owned = OWN a business
   - business_role = Owner, Partner, Founder

4. Integration with analysis framework:
   - PII extraction is an analysis_type
   - Output to facets table, sync to person_facts
   - Leverages existing conversations and analysis_runs

5. Unattributed facts:
   - Phone/email sent without context goes to unattributed_facts
   - Can be resolved later when context available

6. Schema evolution pattern:
   - Use CREATE TABLE IF NOT EXISTS for idempotent migrations
   - Increment schema_version with INSERT OR IGNORE
   - Build & init must succeed before committing

---

## 2026-01-13 - [US-030] Add person_facts table to schema
- Added person_facts table to internal/db/schema.sql
- Includes all fields: id, person_id FK, category, fact_type, fact_value
- Confidence scoring (0.0-1.0) and source attribution
- Three classification flags: is_sensitive, is_identifier, is_hard_identifier
- Evidence field stores quote from original message
- UNIQUE constraint on (person_id, category, fact_type, fact_value) prevents duplicates
- Four indexes: person_id, (category, fact_type), fact_value, and conditional hard_id index
- Schema version incremented from 3 to 4
- Files changed: internal/db/schema.sql
- **Learnings:**
  - WHERE clause on CREATE INDEX is supported in SQLite for conditional indexes
  - This enables efficient queries on hard identifiers without scanning all facts
  - Schema version uses INSERT OR IGNORE, only applies on fresh DBs (existing stay at previous version)
  - comms init is idempotent - safe to run multiple times

---

## 2026-01-13 - [US-031] Add unattributed_facts table to schema
- Added unattributed_facts table to internal/db/schema.sql
- Captures ambiguous data extracted without clear attribution
- Fields: id, fact_type, fact_value, shared_by_person_id, source_event_id, source_conversation_id
- Resolution tracking: resolved_to_person_id, resolution_evidence, resolved_at
- possible_attributions as JSON array for LLM guesses
- Two indexes: (fact_type, fact_value) for lookups, conditional on unresolved
- Schema version incremented from 4 to 5
- Files changed: internal/db/schema.sql
- **Learnings:**
  - Unattributed facts enable graceful handling of "send this to 555-1234" cases
  - Later context ("that's my sister's number") can resolve attribution
  - Conditional index on NULL check is efficient for "unresolved only" queries
  - Pattern: extraction creates unattributed fact, resolution moves to person_facts

---

## 2026-01-13 - [US-032] Add merge_events table to schema
- Added merge_events table to internal/db/schema.sql
- Tracks full lifecycle of identity merges from suggestion to execution
- Fields: id, source_person_id, target_person_id, merge_type, triggering_facts (JSON)
- Status: pending, accepted, rejected, executed
- auto_eligible flag for high-confidence matches (>=0.8 hard identifier collisions)
- Audit trail: similarity_score, resolved_at, resolved_by
- Two indexes: status for filtering workflows, (source, target) for deduplication
- Schema version incremented from 5 to 6
- Files changed: internal/db/schema.sql
- **Learnings:**
  - merge_events replaces merge_suggestions with richer state machine
  - Supports both auto-merge flow and manual review flow
  - triggering_facts as JSON allows storing arbitrary evidence
  - resolved_by distinguishes 'auto' vs user-approved merges
  - Composite index on (source, target) prevents duplicate suggestions

---

## 2026-01-13 - [US-033] Create fact management utilities
- Created internal/identify/facts.go with comprehensive fact management
- Implemented PersonFact struct matching person_facts schema
- Defined 17 hard identifier constants (email, phone, social handles, government IDs)
- Defined 6 soft identifier constants with weights (employer 0.20, location 0.15, profession 0.15, spouse 0.25, school 0.15, birthdate 0.25)
- Implemented InsertFact with ON CONFLICT upsert pattern
- Implemented GetFactsForPerson, GetHardIdentifiers, GetFactsByType, GetFactsByCategory
- Implemented FindFactCollisions with O(F) algorithm using GROUP BY fact_value
- Implemented FindAllHardIdentifierCollisions for resolution pipeline
- Created comprehensive unit tests in facts_test.go
- Files changed: internal/identify/facts.go (new), internal/identify/facts_test.go (new), AGENTS.md
- **Learnings:**
  - ON CONFLICT DO UPDATE with MAX(confidence, excluded.confidence) keeps highest confidence on duplicate
  - SQLite GROUP_CONCAT uses comma separator by default for person ID lists
  - isIdentifierType checks both HardIdentifiers list and SoftIdentifierWeights map
  - Automatic flag setting (is_identifier, is_hard_identifier) based on fact type prevents manual errors
  - Fact collision detection via GROUP BY is O(F) not O(P²) - scales to millions of facts
  - Evidence field stores original message quote for audit trail
  - Three-tier identifier taxonomy: hard (1 match = merge), compound (multi-field), soft (weighted scoring)
  - PersonFact struct uses pointers for optional fields (SourceChannel, Evidence, etc.)
  - splitPersonIDs helper manually parses comma-separated string (no strings.Split to avoid imports)
  - Tests verify constants, helpers, and type detection logic without requiring database
  - boolToInt helper converts Go bool to SQLite INTEGER (0 or 1)

---
