# Ralph Progress Log
Started: 2026-01-11
Project: comms — Unified Communications Cartographer

## Codebase Patterns
<!-- Add reusable patterns here as you discover them -->

- SQLite: Use modernc.org/sqlite (pure Go, no CGO)
- Config: YAML in ~/.config/comms/config.yaml (use internal/config package)
- Data: SQLite in ~/Library/Application Support/Comms/comms.db
- JSON output: All commands support --json flag via Result struct
- Errors: Return structured errors with ok: false in JSON mode
- Adapters: Each adapter implements Adapter interface (Name(), Sync(ctx, db, full))
- Eve DB path: ~/Library/Application Support/Eve/eve.db
- gogcli: Call via exec, parse JSON output
- Schema: Use //go:embed to embed schema.sql into binary
- XDG paths: config.GetConfigDir() and config.GetDataDir() handle platform differences
- Foreign keys: Must enable PRAGMA foreign_keys = ON for each connection
- Read-only DB access: `sql.Open("sqlite", "file:path?mode=ro")`
- Upserts: Use `ON CONFLICT(...) DO UPDATE SET ...` for idempotent inserts
- Sync watermarks: Track last_sync_at per adapter in sync_watermarks table for incremental sync
- Identity resolution: Map external IDs via identities table (channel+identifier -> person_id)
- Tags: Use 'type:value' format, validate type against enum (topic, entity, emotion, project, context)
- Bulk operations: Reuse filter patterns across commands (EventFilter for both query and tag)
- DB query: Default read-only (SELECT only), use --write flag for mutations (INSERT/UPDATE/DELETE)
- Dynamic SQL results: Use []map[string]interface{} with rows.Columns() for flexible schema handling
- External commands: Use exec.LookPath() to validate availability, exec.CommandContext() for execution
- Gmail sync: Use 'after:YYYY/MM/DD' query format, timestamps in milliseconds (divide by 1000)
- Email parsing: Handle "Name <email>" format by extracting text between < and >
- Type assertions: Use two-value ok pattern when reading map[string]interface{}

## Key Files
- cmd/comms/main.go — CLI entry point
- internal/config/config.go — Config management (XDG-compliant)
- internal/db/schema.sql — Database schema
- internal/db/db.go — Database connection
- internal/adapters/*.go — Channel adapters

---

## 2026-01-11 - US-001 Project scaffolding
- Project was already complete with go.mod, Makefile, .goreleaser.yaml, and cobra CLI
- Version command works with both text and JSON output
- Build succeeds without errors
- **Learnings:**
  - Makefile uses ldflags to inject version, commit, and build date
  - .goreleaser.yaml configured for darwin and linux on amd64/arm64
  - Cobra provides clean command structure with persistent flags

---

## 2026-01-11 - US-002 Init command creates config and database
- Created internal/config package with XDG-compliant path functions
- Created internal/db package with schema.sql embedded via //go:embed
- Added init command that creates directories and initializes database
- Init command is idempotent (safe to run multiple times)
- JSON output includes config_dir, data_dir, and db_path
- **Files changed:**
  - internal/config/config.go (new)
  - internal/db/db.go (new)
  - internal/db/schema.sql (new)
  - cmd/comms/main.go (added init command)
  - go.mod/go.sum (added modernc.org/sqlite, gopkg.in/yaml.v3)
- **Learnings:**
  - Use //go:embed directive to bundle schema.sql into binary
  - XDG_CONFIG_HOME defaults to ~/.config on Unix-like systems
  - macOS uses ~/Library/Application Support for data, not XDG paths
  - SQLite PRAGMA foreign_keys must be explicitly enabled per connection
  - modernc.org/sqlite is pure Go (no CGO), perfect for cross-platform builds
  - Result structs with OK bool and optional fields work well for JSON output
  - os.MkdirAll is idempotent (safe to create existing directories)

---

## 2026-01-11 - US-003 Database schema for events, persons, identities
- Schema was already created as part of US-002 implementation
- All tables present: events, persons, identities, event_participants, tags
- Schema versioning supported via schema_version table
- Indexes created on timestamp, channel, person_id, and other key fields
- Foreign key constraints with ON DELETE CASCADE for referential integrity
- **Files changed:**
  - None (already complete from US-002)
- **Learnings:**
  - Schema design supports union-find identity resolution via persons/identities
  - event_participants uses composite primary key for many-to-many relationships
  - tags table supports both user-applied and AI-discovered tags with confidence scores
  - sync_watermarks table enables incremental sync per adapter
  - Using INTEGER for timestamps (Unix epoch) for efficiency

---

## 2026-01-11 - US-004 Me command to configure user identity
- Created internal/me package with identity management functions
- Implemented `comms me set` command with --name, --phone, --email flags
- Implemented `comms me show` command to display current identity
- Ensures only one person can have is_me=1 in the database
- Supports JSON output via --json flag
- **Files changed:**
  - internal/me/me.go (new)
  - cmd/comms/main.go (added me command with set/show subcommands)
  - AGENTS.md (updated with transaction patterns and gotchas)
- **Learnings:**
  - Transaction pattern: Begin transaction, defer Rollback (safe even if committed), then Commit at end
  - Use sql.NullString for nullable database fields (display_name, relationship_type)
  - google/uuid package for generating unique IDs (already in go.mod as indirect dependency)
  - Commands should validate input early (e.g., require at least one flag)
  - When checking for existing rows, use sql.ErrNoRows to distinguish "not found" from other errors
  - Identity conflicts should be detected and reported clearly (e.g., identifier already belongs to another person)
  - SetMeName handles both create (if no me person exists) and update (if exists) cases
  - AddIdentity creates me person with empty name if needed (name can be set later)
  - Use time.Now().Unix() for storing timestamps as INTEGER in SQLite
  - Result structs with OK bool and optional fields work well for both JSON and text output
  - Text output uses ✓ checkmark for success messages (user-friendly)

---
## 2026-01-11 - US-005 Adapters command to list and manage adapters
- Created internal/adapters package with Adapter interface (Name(), Sync())
- Implemented `comms adapters` command to list configured adapters with status
- Implemented `comms connect imessage` to configure iMessage adapter (via Eve)
- Implemented `comms connect gmail --account <email>` to configure Gmail adapter (via gogcli)
- Adapter status checks verify prerequisites (Eve db exists, gmail account configured)
- Config.yaml stores adapter configuration (type, enabled, options)
- All commands support --json flag for structured output
- **Files changed:**
  - internal/adapters/adapter.go (new)
  - cmd/comms/main.go (added adapters, connect commands)
  - AGENTS.md (updated with adapter patterns)
- **Learnings:**
  - Config package already had AdapterConfig struct with type, enabled, and options map
  - Use config.Load() and cfg.Save() to read/write YAML config
  - os.Stat() checks file existence; os.IsNotExist(err) distinguishes "not found" errors
  - Provide helpful error messages with setup instructions when prerequisites missing
  - checkAdapterStatus() function centralizes prerequisite validation logic
  - Adapter interface defines contract: Name() and Sync(ctx, db, full) methods
  - SyncResult struct tracks EventsCreated, EventsUpdated, PersonsCreated, Duration
  - Eve database location: ~/Library/Application Support/Eve/eve.db
  - Gmail adapter stores account email in Options map for later use by sync

---


---

## 2026-01-11 - US-006 Eve adapter pulls events from Eve database
- Created internal/adapters/eve.go implementing the Adapter interface
- Syncs Eve contacts to comms persons and identities tables
- Syncs Eve messages to comms events with proper threading via chat_identifier
- Maps is_from_me boolean to direction field (sent/received)
- Tracks sync watermark in sync_watermarks table for incremental sync
- Handles attachments by checking attachment count and adding to content_types
- Links event_participants via identity resolution (matching contact_identifiers to identities)
- Opens Eve database in read-only mode using file:path?mode=ro
- **Files changed:**
  - internal/adapters/eve.go (new)
  - AGENTS.md (added Eve adapter patterns)
- **Learnings:**
  - Eve schema: contacts/contact_identifiers for people, messages/chats/attachments for events
  - Use `ON CONFLICT(source_adapter, source_id) DO UPDATE` for upsert operations
  - Read-only database access: `sql.Open("sqlite", "file:path?mode=ro")`
  - Sync watermarks enable incremental sync by storing last_sync_at timestamp per adapter
  - Query Eve messages with timestamp filter for incremental sync: `WHERE m.timestamp > ?`
  - Handle nullable fields with sql.NullString and sql.NullInt64
  - Map Eve sender_id to comms person_id via contact_identifiers -> identities lookup
  - Content types are JSON arrays: ["text"], ["text", "attachment"]
  - Thread IDs map to Eve's chat_identifier for conversation grouping
  - Event participants need role: sender, recipient, cc, observer
  - When checking if insert vs update happened, query back the ID after ON CONFLICT
  - NewEveAdapter() constructor validates Eve database exists before creating adapter
  - Adapter returns SyncResult with counts: EventsCreated, EventsUpdated, PersonsCreated, Duration

---

## 2026-01-11 - US-007 Sync command orchestrates adapter sync
- Created internal/sync package with SyncAll and SyncOne orchestration functions
- Implemented `comms sync` command that runs all enabled adapters
- Added `--adapter <name>` flag to sync specific adapter only
- Added `--full` flag to force complete re-sync (ignores watermarks)
- Sync operations handle errors gracefully - one adapter failing doesn't stop others
- Results show events created/updated, persons created, and duration per adapter
- JSON output support via --json flag for machine-readable results
- **Files changed:**
  - internal/sync/sync.go (new)
  - cmd/comms/main.go (added sync command)
  - AGENTS.md (added sync patterns)
- **Learnings:**
  - Sync orchestration should be separate from adapter implementations
  - Use context.Background() for sync operations (can add timeouts later)
  - When running multiple operations, collect results and report all at once
  - One failing adapter shouldn't prevent others from running (graceful degradation)
  - Switch statement in syncAdapter() maps adapter type to constructor
  - AdapterResult struct tracks per-adapter success/failure with detailed stats
  - Duration.String() provides human-readable time format (e.g., "2.5s", "100ms")
  - Exit with error code if any adapter fails, but still show all results
  - Config validation happens before sync (check adapter exists and is enabled)
---

## 2026-01-11 - US-008 Union-find identity resolution
- Created internal/identify package with identity resolution logic
- Implemented `comms identify` command to list all persons with identities and event counts
- Implemented `comms identify --search <term>` for fuzzy searching by name or identifier
- Implemented `comms identify merge <person1> <person2>` for union-find style merging
- Implemented `comms identify add <person> --email/--phone/--identifier` to add identities
- Merge operation transfers all identities and event_participants from person2 to person1
- Duplicate detection prevents conflicting identity assignments
- Cannot merge 'me' person into another person (must be the merge target)
- All commands support JSON output via --json flag
- **Files changed:**
  - internal/identify/identify.go (new)
  - cmd/comms/main.go (added identify command with merge and add subcommands)
  - AGENTS.md (added identity resolution patterns)
- **Learnings:**
  - Union-find merging requires careful handling of duplicate event_participants
  - Use `ON CONFLICT(event_id, person_id, role) DO NOTHING` when transferring event_participants
  - Search with LIKE + LOWER() for case-insensitive fuzzy matching across names and identifiers
  - GetPersonByName matches both canonical_name and display_name for flexibility
  - Joining with event_participants and counting gives useful stats for merge prioritization
  - Merge validation: check if either person is 'me' before allowing merge
  - Custom identifiers use 'channel:identifier' format parsed with strings.SplitN
  - List query orders by event_count DESC for most active contacts first
  - Display event count and last_event_at timestamp to help users identify active contacts
  - Merge is destructive - all person2 data transferred then person2 deleted
  - Transaction pattern ensures atomicity: transfer identities, transfer participants, delete person

---

## 2026-01-11 - US-009 Events query command with filters
- Created internal/query package with EventFilters struct and QueryEvents function
- Implemented `comms events` command with multiple combinable filters
- Added flags: --person, --channel, --since, --until, --direction, --limit
- Dynamic SQL query building based on provided filters
- Participants loaded per event in separate queries (avoid N+1)
- JSON output support via --json flag
- Text output truncates long content to 200 characters
- Date parsing using time.Parse with "2006-01-02" layout
- **Files changed:**
  - internal/query/query.go (new)
  - cmd/comms/main.go (added events command and parseDate helper)
  - AGENTS.md (added query patterns)
- **Learnings:**
  - Dynamic SQL building: Build query string and args slice based on provided filters
  - Use DISTINCT when joining with event_participants to avoid duplicate events in results
  - All filters are ANDed together in WHERE clause for precise filtering
  - Default limit of 100 prevents overwhelming output on large datasets
  - time.Parse("2006-01-02", dateStr) parses YYYY-MM-DD dates to time.Time
  - Load related data (participants) in separate query to keep main query simple
  - COALESCE(display_name, canonical_name) prioritizes display name in output
  - ORDER BY timestamp DESC shows most recent events first
  - Separate getEventParticipants function allows reuse and cleaner code structure
  - FormatTimestamp helper uses "2006-01-02 15:04:05" layout for human-readable dates
  - Text output shows filter description when filters applied
  - Validate direction enum (sent/received/observed) early before querying
  - Result struct includes both Count and Events array for JSON consumers

---

## 2026-01-11 - US-010 People command lists contacts
- Implemented `comms people` command with three modes: list all, search, and person detail
- List mode: `comms people` shows all contacts sorted by event count (DESC)
- Top N mode: `comms people --top 20` limits to top N contacts by event count
- Search mode: `comms people --search 'term'` searches by name or identifier
- Detail mode: `comms people 'Name'` shows full details for a specific person
- All modes support JSON output via --json flag
- Reuses identify package functions (ListAll, Search, GetPersonByName) for consistency
- **Files changed:**
  - cmd/comms/main.go (added people command with list/search/detail modes)
  - AGENTS.md (added people command patterns)
  - scripts/ralph/prd.json (marked US-010 as passing)
- **Learnings:**
  - Reusing existing packages reduces duplication - identify package already had all needed functions
  - Cobra Args: cobra.MaximumNArgs(1) allows 0 or 1 positional argument
  - Mode switching: check len(args) to distinguish list mode (no args) from detail mode (1 arg)
  - --top N flag is simple to implement when results are already sorted by desired field
  - Text output formatting: inline identities for list view (channel:identifier), detailed for detail view
  - Display name formatting: show [display_name] if different from canonical_name
  - Event statistics add context: show event count and last event timestamp in listings
  - Consistent Result struct pattern works well across all commands

---

## 2026-01-11 - US-011 Timeline command for temporal view
- Created internal/timeline package with QueryTimeline function
- Implemented `comms timeline` command with flexible date parsing (YYYY, YYYY-MM, YYYY-MM-DD)
- Added `--today` and `--week` convenience flags for common use cases
- Timeline aggregates events by date with breakdowns by sender, channel, and direction
- Both JSON and text output modes with emoji calendar icons for visual appeal
- **Files changed:**
  - internal/timeline/timeline.go (new)
  - cmd/comms/main.go (added timeline command)
  - AGENTS.md (added timeline patterns)
  - scripts/ralph/prd.json (marked US-011 as passing)
- **Learnings:**
  - SQLite DATE() function with 'unixepoch' and 'localtime' modifiers groups timestamps by day
  - Flexible date parsing: Try multiple time.Parse layouts in sequence (YYYY-MM-DD, YYYY-MM, YYYY)
  - Time range boundaries: Use time.Date() with AddDate() for precise start/end (exclusive end)
  - Week calculation: Convert Sunday from 0 to 7, then subtract (weekday-1) to find Monday
  - Map-based aggregation: Use map[string]int for counting by sender/channel/direction
  - Two-pass query pattern: First pass for detailed breakdown, second pass for accurate totals
  - Avoid shadowing err variable in if statements - declare once at function level or use := each time
  - cobra.MaximumNArgs(1) allows optional positional argument (0 or 1)
  - Flag precedence: Check --today, then --week, then positional arg for flexible UX
  - Empty results handling: Show helpful "No events found" message instead of empty output

---

## 2026-01-11 - US-012 Tags command for soft tagging
- Created internal/tag package with ListAll, ListByType, ListByEvent, Add, AddBulk, Delete functions
- Implemented `comms tag list` command with optional --type filter
- Implemented `comms tag add` command with two modes:
  - Single event mode: --event <id> --tag <type:value>
  - Bulk mode: --person/--channel/--since/--until filters with --tag <type:value>
- Tag types are validated against enum: topic, entity, emotion, project, context
- Tags use 'type:value' format (e.g., 'project:htaa', 'context:business')
- Duplicate tag detection prevents same tag being added twice to same event
- Tags support confidence scores (0.0-1.0) for analysis-discovered tags via --confidence flag
- Source field tracks origin: 'user' for manual tags, 'analysis' for AI-discovered tags
- JSON output support via --json flag for all tag commands
- **Files changed:**
  - internal/tag/tag.go (new)
  - cmd/comms/main.go (added tag command with list and add subcommands)
  - AGENTS.md (added tag usage examples and patterns)
  - scripts/ralph/prd.json (marked US-012 as passing)
- **Learnings:**
  - Tag validation should happen early - check tag type against valid enum before database operations
  - Duplicate detection query: `SELECT EXISTS(SELECT 1 FROM tags WHERE event_id = ? AND tag_type = ? AND value = ?)`
  - Bulk tagging reuses EventFilter pattern from query package for consistency
  - buildEventFilterQuery() builds dynamic SQL based on provided filters (person, channel, time range)
  - Skip duplicates silently in bulk mode - don't fail entire operation if one event already has the tag
  - Tag list shows event preview (channel, content snippet) for context when viewing tags
  - TagWithEvent struct joins tags with events table for richer display in list command
  - Use sql.NullFloat64 for optional confidence field that can be NULL
  - SplitN with limit 2 for parsing 'type:value' allows colons in value part
  - Return count of events tagged in bulk mode for user feedback

---

## 2026-01-11 - US-013 DB query command for raw SQL access
- Implemented `comms db query <sql>` command for direct SQL access to comms.db
- Default behavior is read-only - only SELECT queries allowed without --write flag
- Mutation detection checks for INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, TRUNCATE keywords
- Added --write flag to explicitly allow mutation queries for safety
- Supports both text output (tab-separated table) and JSON output via --json flag
- Dynamic column detection using rows.Columns() works with any query schema
- Results returned as []map[string]interface{} for flexible handling
- Text output formats as table with column headers, separator line, and row count
- Handles NULL values by displaying "NULL" in text output
- Converts []byte values to strings when appropriate for text fields
- **Files changed:**
  - cmd/comms/main.go (added db command with query subcommand)
  - AGENTS.md (added raw SQL query examples and patterns)
  - scripts/ralph/prd.json (marked US-013 as passing)
- **Learnings:**
  - Mutation detection pattern: Check uppercase SQL with strings.HasPrefix for safety keywords
  - Dynamic query results: Use []interface{} for values and []interface{} for value pointers when scanning
  - Type assertion for []byte to string conversion needed for text fields from SQLite
  - rows.Columns() provides column names dynamically for any query
  - cobra.ExactArgs(1) ensures exactly one positional argument (the SQL query)
  - Text output uses strings.Join with tab separator for simple table formatting
  - Result struct with Rows []map[string]interface{} allows flexible JSON output
  - Safety-first approach: Require explicit --write flag for mutations prevents accidents
  - Error handling at each step: db open, query execution, column retrieval, row scanning
  - defer rows.Close() and defer database.Close() ensure cleanup even on errors

---

## 2026-01-11 - US-014 Gmail adapter pulls events from gogcli
- Created internal/adapters/gmail.go implementing Adapter interface
- Syncs Gmail threads and messages via gogcli command-line tool
- Maps Gmail messages to comms events with proper threading via thread_id
- Extracts participants from to/from/cc headers and creates persons/identities
- Supports incremental sync using 'after:YYYY/MM/DD' query syntax
- Determines message direction via SENT label in labelIds array
- Added Gmail adapter to sync orchestration in internal/sync/sync.go
- **Files changed:**
  - internal/adapters/gmail.go (new)
  - internal/sync/sync.go (added Gmail adapter case)
  - AGENTS.md (added Gmail adapter patterns)
  - scripts/ralph/prd.json (marked US-014 as passing)
- **Learnings:**
  - exec.LookPath() validates command availability before creating adapter
  - gogcli called via exec.CommandContext with --json flag for structured output
  - Gmail search query uses 'after:YYYY/MM/DD' format for date-based filtering
  - Gmail API returns timestamps in milliseconds, must divide by 1000 for Unix seconds
  - Email address parsing handles both "Name <email>" and plain "email" formats using string manipulation
  - Gmail threads contain array of messages, each message becomes separate event
  - Direction determined by checking if "SENT" exists in message.LabelIDs array
  - Body extraction recursively searches payload.Parts for text/plain or text/html MIME types
  - Attachments detected by checking payload.Filename field recursively through parts
  - Email addresses stored as identities with channel='email' for person resolution
  - Type assertions required when reading config.Options map[string]interface{} - use two-value ok pattern
  - Headers stored in array format, converted to map[string]string for easy access
  - Subject included in event content along with body text
  - Participant roles: sender (from), recipient (to), cc (cc field)
  - getOrCreatePersonByEmail handles identity lookup and person creation atomically
  - Warning messages printed for individual thread failures, but sync continues for other threads
  - content_types array includes "attachment" when hasAttachments returns true
  - Email used as canonical_name for new persons (user can update with display name later)

---

## 2026-01-11 - US-015 SKILL.md for Nexus integration
- SKILL.md was already complete and met all acceptance criteria
- Frontmatter contains nexus metadata with emoji, OS requirements, binaries, and install methods
- All commands documented across Setup, Sync, Query, Identity Management, and Tags sections
- Bootstrap section provides step-by-step instructions for AI agents
- Tips for Agents section includes example workflow patterns
- **Files changed:**
  - scripts/ralph/prd.json (marked US-015 as passing)
  - scripts/ralph/progress.txt (added US-015 learnings)
- **Learnings:**
  - SKILL.md is user-facing documentation that doubles as machine-readable skill definition
  - Nexus skill format uses YAML frontmatter with metadata object for integration
  - metadata.nexus.emoji provides visual identifier in Nexus UI
  - metadata.nexus.requires.bins declares binary dependencies for installation validation
  - metadata.nexus.install array supports multiple installation methods (brew, go, etc.)
  - Bootstrap section should be concrete and executable (not just conceptual)
  - AI agent tips should include realistic example queries with expected workflows
  - SKILL.md lives at project root for easy discovery by both humans and tooling

---

## 2026-01-13 - US-016 Add threads table to schema
- Added threads table to schema.sql with all required fields (id, channel, name, source_adapter, source_id, parent_thread_id, created_at, updated_at)
- Added UNIQUE constraint on (source_adapter, source_id) to prevent duplicate thread imports
- Created three indexes: idx_threads_channel, idx_threads_parent, idx_threads_name
- Incremented schema version from 1 to 2
- Verified go build succeeds and comms init applies schema without error
- **Files changed:**
  - internal/db/schema.sql (added threads table and indexes, incremented version to 2)
  - scripts/ralph/prd.json (marked US-016 as passing)
- **Learnings:**
  - Threads table is generic container for chats, email threads, channels, sessions across all adapters
  - No is_group field - group status derived from event_participants (per design doc section 2)
  - Parent thread support via self-referencing foreign key (for Slack/Discord thread-in-channel pattern)
  - Schema version uses INSERT OR IGNORE which won't update existing databases, but CREATE TABLE IF NOT EXISTS allows safe schema evolution
  - Fresh databases get version 2, existing databases get new table but keep version 1 (acceptable)
  - Positioning threads table before sync_watermarks logically groups related tables
  - UNIQUE(source_adapter, source_id) ensures each external thread imported exactly once

---

## 2026-01-13 - US-017 Add attachments table to schema
- Added attachments table to schema.sql with all required fields from design document
- Created table with: id (PK), event_id (FK CASCADE), filename, mime_type, size_bytes
- Added type hints: media_type (image/video/audio/document/sticker/link)
- Added storage fields: storage_uri, storage_type (local/s3/url/inline)
- Added deduplication support: content_hash field
- Added source tracking: source_id for original attachment ID from source system
- Added metadata_json for extensible metadata (width/height, duration, etc.)
- Created four indexes: event_id, mime_type, media_type, content_hash
- Incremented schema version from 2 to 3
- Verified go build succeeds and comms init applies schema without error
- **Files changed:**
  - internal/db/schema.sql (added attachments table and indexes, incremented version to 3)
  - scripts/ralph/prd.json (marked US-017 as passing)
  - scripts/ralph/progress.txt (added US-017 learnings)
- **Learnings:**
  - Attachments table matches schema design document section 4 exactly
  - Foreign key with ON DELETE CASCADE ensures orphaned attachment records are cleaned up
  - Positioned attachments table immediately after threads table for logical grouping
  - media_type provides queryable categorization (image/video/audio/etc.)
  - storage_uri supports multiple storage backends (file://, s3://, https://)
  - content_hash enables deduplication across events with same attachment
  - metadata_json allows flexible storage of format-specific metadata without schema changes
  - source_id preserves original attachment ID from source system for idempotent imports
  - Schema version incremented in INSERT OR IGNORE statement at end of schema.sql
  - Table comments match design document for clarity
