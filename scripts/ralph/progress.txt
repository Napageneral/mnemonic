# Ralph Progress Log
Started: 2026-01-11
Project: comms — Unified Communications Cartographer

## Codebase Patterns
<!-- Add reusable patterns here as you discover them -->

- SQLite: Use modernc.org/sqlite (pure Go, no CGO)
- Config: YAML in ~/.config/comms/config.yaml (use internal/config package)
- Data: SQLite in ~/Library/Application Support/Comms/comms.db
- JSON output: All commands support --json flag via Result struct
- Errors: Return structured errors with ok: false in JSON mode
- Adapters: Each adapter implements Adapter interface (Name(), Sync(ctx, db, full))
- Eve DB path: ~/Library/Application Support/Eve/eve.db
- gogcli: Call via exec, parse JSON output
- Schema: Use //go:embed to embed schema.sql into binary
- XDG paths: config.GetConfigDir() and config.GetDataDir() handle platform differences
- Foreign keys: Must enable PRAGMA foreign_keys = ON for each connection
- Read-only DB access: `sql.Open("sqlite", "file:path?mode=ro")`
- Upserts: Use `ON CONFLICT(...) DO UPDATE SET ...` for idempotent inserts
- Sync watermarks: Track last_sync_at per adapter in sync_watermarks table for incremental sync
- Identity resolution: Map external IDs via identities table (channel+identifier -> person_id)

## Key Files
- cmd/comms/main.go — CLI entry point
- internal/config/config.go — Config management (XDG-compliant)
- internal/db/schema.sql — Database schema
- internal/db/db.go — Database connection
- internal/adapters/*.go — Channel adapters

---

## 2026-01-11 - US-001 Project scaffolding
- Project was already complete with go.mod, Makefile, .goreleaser.yaml, and cobra CLI
- Version command works with both text and JSON output
- Build succeeds without errors
- **Learnings:**
  - Makefile uses ldflags to inject version, commit, and build date
  - .goreleaser.yaml configured for darwin and linux on amd64/arm64
  - Cobra provides clean command structure with persistent flags

---

## 2026-01-11 - US-002 Init command creates config and database
- Created internal/config package with XDG-compliant path functions
- Created internal/db package with schema.sql embedded via //go:embed
- Added init command that creates directories and initializes database
- Init command is idempotent (safe to run multiple times)
- JSON output includes config_dir, data_dir, and db_path
- **Files changed:**
  - internal/config/config.go (new)
  - internal/db/db.go (new)
  - internal/db/schema.sql (new)
  - cmd/comms/main.go (added init command)
  - go.mod/go.sum (added modernc.org/sqlite, gopkg.in/yaml.v3)
- **Learnings:**
  - Use //go:embed directive to bundle schema.sql into binary
  - XDG_CONFIG_HOME defaults to ~/.config on Unix-like systems
  - macOS uses ~/Library/Application Support for data, not XDG paths
  - SQLite PRAGMA foreign_keys must be explicitly enabled per connection
  - modernc.org/sqlite is pure Go (no CGO), perfect for cross-platform builds
  - Result structs with OK bool and optional fields work well for JSON output
  - os.MkdirAll is idempotent (safe to create existing directories)

---

## 2026-01-11 - US-003 Database schema for events, persons, identities
- Schema was already created as part of US-002 implementation
- All tables present: events, persons, identities, event_participants, tags
- Schema versioning supported via schema_version table
- Indexes created on timestamp, channel, person_id, and other key fields
- Foreign key constraints with ON DELETE CASCADE for referential integrity
- **Files changed:**
  - None (already complete from US-002)
- **Learnings:**
  - Schema design supports union-find identity resolution via persons/identities
  - event_participants uses composite primary key for many-to-many relationships
  - tags table supports both user-applied and AI-discovered tags with confidence scores
  - sync_watermarks table enables incremental sync per adapter
  - Using INTEGER for timestamps (Unix epoch) for efficiency

---

## 2026-01-11 - US-004 Me command to configure user identity
- Created internal/me package with identity management functions
- Implemented `comms me set` command with --name, --phone, --email flags
- Implemented `comms me show` command to display current identity
- Ensures only one person can have is_me=1 in the database
- Supports JSON output via --json flag
- **Files changed:**
  - internal/me/me.go (new)
  - cmd/comms/main.go (added me command with set/show subcommands)
  - AGENTS.md (updated with transaction patterns and gotchas)
- **Learnings:**
  - Transaction pattern: Begin transaction, defer Rollback (safe even if committed), then Commit at end
  - Use sql.NullString for nullable database fields (display_name, relationship_type)
  - google/uuid package for generating unique IDs (already in go.mod as indirect dependency)
  - Commands should validate input early (e.g., require at least one flag)
  - When checking for existing rows, use sql.ErrNoRows to distinguish "not found" from other errors
  - Identity conflicts should be detected and reported clearly (e.g., identifier already belongs to another person)
  - SetMeName handles both create (if no me person exists) and update (if exists) cases
  - AddIdentity creates me person with empty name if needed (name can be set later)
  - Use time.Now().Unix() for storing timestamps as INTEGER in SQLite
  - Result structs with OK bool and optional fields work well for both JSON and text output
  - Text output uses ✓ checkmark for success messages (user-friendly)

---
## 2026-01-11 - US-005 Adapters command to list and manage adapters
- Created internal/adapters package with Adapter interface (Name(), Sync())
- Implemented `comms adapters` command to list configured adapters with status
- Implemented `comms connect imessage` to configure iMessage adapter (via Eve)
- Implemented `comms connect gmail --account <email>` to configure Gmail adapter (via gogcli)
- Adapter status checks verify prerequisites (Eve db exists, gmail account configured)
- Config.yaml stores adapter configuration (type, enabled, options)
- All commands support --json flag for structured output
- **Files changed:**
  - internal/adapters/adapter.go (new)
  - cmd/comms/main.go (added adapters, connect commands)
  - AGENTS.md (updated with adapter patterns)
- **Learnings:**
  - Config package already had AdapterConfig struct with type, enabled, and options map
  - Use config.Load() and cfg.Save() to read/write YAML config
  - os.Stat() checks file existence; os.IsNotExist(err) distinguishes "not found" errors
  - Provide helpful error messages with setup instructions when prerequisites missing
  - checkAdapterStatus() function centralizes prerequisite validation logic
  - Adapter interface defines contract: Name() and Sync(ctx, db, full) methods
  - SyncResult struct tracks EventsCreated, EventsUpdated, PersonsCreated, Duration
  - Eve database location: ~/Library/Application Support/Eve/eve.db
  - Gmail adapter stores account email in Options map for later use by sync

---


---

## 2026-01-11 - US-006 Eve adapter pulls events from Eve database
- Created internal/adapters/eve.go implementing the Adapter interface
- Syncs Eve contacts to comms persons and identities tables
- Syncs Eve messages to comms events with proper threading via chat_identifier
- Maps is_from_me boolean to direction field (sent/received)
- Tracks sync watermark in sync_watermarks table for incremental sync
- Handles attachments by checking attachment count and adding to content_types
- Links event_participants via identity resolution (matching contact_identifiers to identities)
- Opens Eve database in read-only mode using file:path?mode=ro
- **Files changed:**
  - internal/adapters/eve.go (new)
  - AGENTS.md (added Eve adapter patterns)
- **Learnings:**
  - Eve schema: contacts/contact_identifiers for people, messages/chats/attachments for events
  - Use `ON CONFLICT(source_adapter, source_id) DO UPDATE` for upsert operations
  - Read-only database access: `sql.Open("sqlite", "file:path?mode=ro")`
  - Sync watermarks enable incremental sync by storing last_sync_at timestamp per adapter
  - Query Eve messages with timestamp filter for incremental sync: `WHERE m.timestamp > ?`
  - Handle nullable fields with sql.NullString and sql.NullInt64
  - Map Eve sender_id to comms person_id via contact_identifiers -> identities lookup
  - Content types are JSON arrays: ["text"], ["text", "attachment"]
  - Thread IDs map to Eve's chat_identifier for conversation grouping
  - Event participants need role: sender, recipient, cc, observer
  - When checking if insert vs update happened, query back the ID after ON CONFLICT
  - NewEveAdapter() constructor validates Eve database exists before creating adapter
  - Adapter returns SyncResult with counts: EventsCreated, EventsUpdated, PersonsCreated, Duration
